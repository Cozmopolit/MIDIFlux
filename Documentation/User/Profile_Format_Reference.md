# Profile Format Reference

MIDIFlux profiles are JSON files that define how MIDI input maps to actions. This document describes every structural element of the format. For details on individual action types and their parameters, see [Action Reference](Action_Reference.md).

A complete annotated example ships with MIDIFlux at `%AppData%\MIDIFlux\profiles\examples\profile-format-reference.json` and is referenced throughout this guide.

## Top-Level Structure

```json
{
  "ProfileName": "Profile Format Reference",
  "Description": "Human-readable description of this profile",
  "InitialStates": { ... },
  "MidiDevices": [ ... ]
}
```

| Property | Type | Required | Description |
|---|---|---|---|
| `ProfileName` | string | Yes | Display name shown in the GUI and system tray menu |
| `Description` | string | No | Free-text description for documentation purposes |
| `InitialStates` | object | No | Pre-defined state keys for stateful actions (see [Initial States](#initial-states)) |
| `MidiDevices` | array | Yes | One or more device configurations containing mappings |

## Initial States

The optional `InitialStates` object declares state keys used by `AlternatingAction`, `StateConditionalAction`, and `SetStateAction`. Each key maps to an integer starting value.

```json
"InitialStates": {
  "MuteToggle": 0
}
```

**Rules:**
- Keys must be **alphanumeric only** (no spaces, hyphens, or special characters)
- Values are integers (typically `0` or `1`)
- States are **profile-scoped** — they reset when a different profile is activated
- Only pre-declared keys are managed; referencing an undeclared key in an action is an error
- Internal state keys (auto-generated by actions like `AlternatingAction`) use an asterisk prefix (e.g., `*Key65`) and do not need to be declared here

## Device Configuration

Each entry in `MidiDevices` targets a specific MIDI device or all devices via wildcard.

```json
{
  "DeviceName": "Arturia KeyStep",
  "Description": "Mappings that only trigger from this specific device",
  "Mappings": [ ... ]
}
```

| Property | Type | Required | Description |
|---|---|---|---|
| `DeviceName` | string | Yes | Exact device name as reported by the OS, or `"*"` for wildcard |
| `Description` | string | No | Human-readable label for this device block |
| `Mappings` | array | Yes | List of input-to-action mappings for this device |

### Device Name Matching

- **Exact name** (e.g., `"Arturia KeyStep"`): Only MIDI events from this device trigger the mappings. Use the **MIDI Input Detection** dialog to discover the exact name your OS reports.
- **Wildcard** (`"*"`): Mappings trigger from any connected MIDI device. Useful for portable profiles that work regardless of hardware.
- A profile can contain **both** named and wildcard device blocks. Named devices are checked first; the wildcard block acts as a fallback.

## Mapping Configuration

Each mapping connects a specific MIDI input event to an action.

```json
{
  "Description": "Play/Pause — simple key press on a named device",
  "IsEnabled": true,
  "InputType": "NoteOn",
  "Note": 60,
  "ControlNumber": null,
  "Channel": 1,
  "Action": { ... },
  "SysExPattern": null
}
```

| Property | Type | Required | Description |
|---|---|---|---|
| `Description` | string | No | Human-readable label for this mapping |
| `IsEnabled` | bool | No | `true` (default) to process this mapping, `false` to skip it at runtime |
| `InputType` | string | Yes | MIDI event type to listen for (see [Input Types](#input-types)) |
| `Note` | int or null | Conditional | MIDI note number (0–127). Required for `NoteOn` / `NoteOff` |
| `ControlNumber` | int or null | Conditional | CC number (0–127). Required for `ControlChangeAbsolute` / `ControlChangeRelative` |
| `Channel` | int or null | No | MIDI channel 1–16, or `null` to match any channel |
| `Action` | object | Yes | The action to execute (see [Action Structure](#action-structure)) |
| `SysExPattern` | string or null | Conditional | Hex byte pattern. Required for `SysEx` input type |

### Disabled Mappings

Set `"IsEnabled": false` to keep a mapping in the profile without it being active. This is useful for temporarily disabling a mapping or keeping it as a reference:

```json
{
  "Description": "Disabled mapping — kept for reference but skipped at runtime",
  "IsEnabled": false,
  "InputType": "NoteOn",
  "Note": 127,
  "Channel": 1,
  "Action": { ... },
  "SysExPattern": null
}
```

## Input Types

The `InputType` field determines which kind of MIDI message triggers the mapping. Each type requires specific companion fields.

| InputType | Category | Required Fields | Description |
|---|---|---|---|
| `NoteOn` | Trigger | `Note`, `Channel` | Key/pad/button press. Velocity is passed to the action as MIDI value (0–127) |
| `NoteOff` | Trigger | `Note`, `Channel` | Key/pad/button release |
| `ControlChangeAbsolute` | Absolute Value | `ControlNumber`, `Channel` | Faders, absolute knobs — value represents position (0–127) |
| `ControlChangeRelative` | Relative Value | `ControlNumber`, `Channel` | Endless encoders, jog wheels — value indicates direction and magnitude |
| `SysEx` | Trigger | `SysExPattern` | System Exclusive messages — matched by byte pattern |

> **Legacy note:** The value `"ControlChange"` is accepted for backward compatibility and treated as `ControlChangeAbsolute`.

### Input Type Categories

Actions declare which input categories they are compatible with:

- **Trigger**: Discrete one-shot events. Most actions (keyboard, mouse, sound, sequences) work here.
- **Absolute Value**: Continuous 0–127 range. Actions like `SystemVolumeAction` and `ConditionalAction` use the value directly.
- **Relative Value**: Direction + magnitude. Only `RelativeCCAction` is designed for this category.

### SysEx Patterns

SysEx patterns are space-separated hex bytes. Use `XX` as a wildcard to match any byte at that position:

```json
"SysExPattern": "F0 7E 7F 06 01 F7"
"SysExPattern": "F0 00 20 29 02 18 0A XX XX F7"
```

- Patterns must start with `F0` and end with `F7` (standard SysEx framing)
- `XX` matches any single byte — useful for ignoring variable fields like velocity or position
- `Channel` should be `null` for SysEx (SysEx messages are not channel-specific)

## Action Structure

Every action in a profile follows the same three-field structure:

```json
"Action": {
  "$type": "KeyPressReleaseAction",
  "Parameters": {
    "VirtualKeyCode": "MediaPlayPause"
  },
  "Description": "Media Play/Pause"
}
```

| Property | Type | Required | Description |
|---|---|---|---|
| `$type` | string | Yes | Action type discriminator — determines which action class is instantiated |
| `Parameters` | object | Yes | Action-specific parameters (can be `{}` for parameterless actions) |
| `Description` | string | No | Human-readable label. Auto-generated from parameters if omitted |

### Nested Actions

Complex actions contain other actions in their parameters. These sub-actions use the exact same `$type` / `Parameters` / `Description` structure, enabling arbitrary nesting depth.

**SequenceAction** — executes sub-actions in order:
```json
{
  "$type": "SequenceAction",
  "Parameters": {
    "SubActions": [
      { "$type": "KeyDownAction", "Parameters": { "VirtualKeyCode": "ControlKey" }, "Description": "Hold Ctrl" },
      { "$type": "KeyPressReleaseAction", "Parameters": { "VirtualKeyCode": "S" }, "Description": "Press S" },
      { "$type": "KeyUpAction", "Parameters": { "VirtualKeyCode": "ControlKey" }, "Description": "Release Ctrl" }
    ]
  },
  "Description": "Ctrl+S save sequence"
}
```

**AlternatingAction** — toggles between two actions on repeated triggers:
```json
{
  "$type": "AlternatingAction",
  "Parameters": {
    "PrimaryAction": { "$type": "KeyPressReleaseAction", "Parameters": { "VirtualKeyCode": "VolumeMute" }, "Description": "Mute" },
    "SecondaryAction": { "$type": "KeyPressReleaseAction", "Parameters": { "VirtualKeyCode": "VolumeMute" }, "Description": "Unmute" },
    "StartWithPrimary": true,
    "StateKey": "MuteToggle"
  },
  "Description": "Toggle mute on/off"
}
```

When `StateKey` references a key declared in `InitialStates`, the toggle state persists across triggers within the profile session.

For the full list of action types and their parameters, see [Action Reference](Action_Reference.md).

## Complete Example

The file `profile-format-reference.json` (installed to `%AppData%\MIDIFlux\profiles\examples\`) demonstrates every structural feature described above in a single working profile:

- **Profile metadata**: `ProfileName`, `Description`
- **Initial states**: `MuteToggle` state key for the alternating action
- **Named device**: `"Arturia KeyStep"` with `NoteOn` and `NoteOff` mappings
- **Wildcard device**: `"*"` with `NoteOn`, `ControlChangeAbsolute`, and `SysEx` mappings
- **Simple action**: `KeyPressReleaseAction` (media keys)
- **Nested action**: `SequenceAction` containing `KeyDown` → `KeyPressRelease` → `KeyUp` for Ctrl+S
- **Wrapper action**: `AlternatingAction` with state key for mute toggle
- **Absolute CC**: `SystemVolumeAction` driven by a fader (CC 7)
- **SysEx pattern**: Exact byte match triggering F12
- **Disabled mapping**: `"IsEnabled": false` showing how to deactivate without deleting
- **Multi-channel**: Mappings on channels 1 and 2

## File Location and Management

- **Profiles directory**: `%AppData%\MIDIFlux\profiles\`
- **Examples**: `%AppData%\MIDIFlux\profiles\examples\` (auto-installed on first run, never overwritten)
- **File extension**: `.json` (required)
- **Encoding**: UTF-8

Profiles can be created and edited through:
1. **GUI**: Right-click tray icon → Configure Mapping Profiles → New / Edit
2. **Text editor**: Edit the JSON directly
3. **MCP tools**: `midi_add_device`, `midi_add_mapping`, `midi_save_config` for programmatic creation

## Related Documentation

- **[Action Reference](Action_Reference.md)**: Complete list of action types with parameters
- **[Getting Started](Getting_Started.md)**: First-time setup and basic usage
- **[GameController Quickstart](GameController_Quickstart.md)**: Game controller emulation setup
- **[Troubleshooting](Troubleshooting.md)**: Common issues and solutions
